# Example deployment using Azure Key Vault for KSM config
#
# Prerequisites:
#   1. KSM config stored in Azure Key Vault
#   2. Managed identity with Key Vault access
#   3. Federated credential created
#   4. K8s ServiceAccount with azure.workload.identity annotation

apiVersion: apps/v1
kind: Deployment
metadata:
  name: azure-secrets-example
  labels:
    app: azure-secrets-example
spec:
  replicas: 1
  selector:
    matchLabels:
      app: azure-secrets-example
  template:
    metadata:
      labels:
        app: azure-secrets-example
        azure.workload.identity/use: "true"  # Required for Azure WI
      annotations:
        # Enable Keeper injection
        keeper.security/inject: "true"

        # Use Azure Key Vault for KSM config
        keeper.security/auth-method: "azure-key-vault"
        keeper.security/azure-vault-name: "mykeyvault"        # Update this
        keeper.security/azure-secret-name: "ksm-config"

        # Secret to inject
        keeper.security/secret: "demo-secret"
        keeper.security/refresh-interval: "5m"
    spec:
      # Use ServiceAccount with Azure client-id annotation
      serviceAccountName: myapp-sa

      containers:
      - name: app
        image: nginx:alpine
        ports:
        - containerPort: 80
        command:
        - /bin/sh
        - -c
        - |
          echo "Keeper K8s Injector - Azure Key Vault Example"
          echo "KSM config fetched from Azure Key Vault using Workload Identity"

          while [ ! -f /keeper/secrets/demo-secret.json ]; do
            echo "Waiting for secret injection..."
            sleep 2
          done

          echo "Secret injected successfully!"
          ls -lah /keeper/secrets/
          tail -f /dev/null
