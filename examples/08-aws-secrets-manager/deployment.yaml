# Example deployment using AWS Secrets Manager for KSM config
#
# Prerequisites:
#   1. KSM config stored in AWS Secrets Manager
#   2. IAM role created with Secrets Manager access
#   3. ServiceAccount created with eks.amazonaws.com/role-arn annotation
#
# Usage:
#   1. Update aws-secret-id and aws-region below
#   2. kubectl apply -f serviceaccount.yaml
#   3. kubectl apply -f deployment.yaml
#   4. kubectl logs deployment/aws-secrets-example -c keeper-secrets-sidecar

apiVersion: apps/v1
kind: Deployment
metadata:
  name: aws-secrets-example
  labels:
    app: aws-secrets-example
spec:
  replicas: 1
  selector:
    matchLabels:
      app: aws-secrets-example
  template:
    metadata:
      labels:
        app: aws-secrets-example
      annotations:
        # Enable Keeper injection
        keeper.security/inject: "true"

        # Use AWS Secrets Manager for KSM config
        keeper.security/auth-method: "aws-secrets-manager"
        keeper.security/aws-secret-id: "prod/keeper/ksm-config"  # ← Update this
        keeper.security/aws-region: "us-west-2"                   # ← Update this

        # Secret to inject (from Keeper)
        keeper.security/secret: "demo-secret"

        # Refresh interval
        keeper.security/refresh-interval: "5m"
    spec:
      # IMPORTANT: Use ServiceAccount with IAM role
      serviceAccountName: myapp-sa

      containers:
      - name: app
        image: nginx:alpine
        ports:
        - containerPort: 80
        command:
        - /bin/sh
        - -c
        - |
          echo "Keeper K8s Injector - AWS Secrets Manager Example"
          echo ""
          echo "This pod fetches its KSM configuration from AWS Secrets Manager"
          echo "using IRSA (IAM Roles for Service Accounts)."
          echo ""
          echo "No static credentials stored in Kubernetes!"
          echo ""

          # Wait for secret to be injected
          while [ ! -f /keeper/secrets/demo-secret.json ]; do
            echo "Waiting for secret injection..."
            sleep 2
          done

          echo "Secret successfully injected!"
          echo ""
          echo "Secret file: /keeper/secrets/demo-secret.json"
          ls -lah /keeper/secrets/

          # Keep container running
          tail -f /dev/null
---
apiVersion: v1
kind: Service
metadata:
  name: aws-secrets-example
  labels:
    app: aws-secrets-example
spec:
  type: ClusterIP
  ports:
  - port: 80
    targetPort: 80
  selector:
    app: aws-secrets-example
